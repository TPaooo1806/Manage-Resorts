<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết Resort</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        * { box-sizing: inherit; }
        .detail-container { max-width: 1200px; margin: 120px auto 40px; padding: 0 20px; }
        .resort-header { text-align: left; margin-bottom: 30px; }
        .resort-header h1 { font-size: 2.8rem; font-weight: 800; color: #2d3748; margin-bottom: 8px; }
        .resort-location { color: #718096; font-size: 1.1rem; font-weight: 500; }
        .image-gallery { margin-bottom: 40px; }
        .main-image img { width: 100%; height: 550px; object-fit: cover; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); }
        .thumbnail-gallery { display: flex; gap: 12px; margin-top: 15px; overflow-x: auto; padding-bottom: 10px; }
        .thumbnail-gallery img { width: 120px; height: 80px; object-fit: cover; border-radius: 12px; cursor: pointer; border: 3px solid transparent; transition: all 0.3s; }
        .thumbnail-gallery img.active { border-color: #667eea; box-shadow: 0 0 15px rgba(102,126,234,0.5); }
        .resort-details-wrapper { display: flex; gap: 40px; margin-top: 30px; }
        .details-main { flex: 2; }
        .details-main h2 { font-size: 1.8rem; font-weight: 700; color: #2d3748; border-bottom: 2px solid #e2e8f0; padding-bottom: 12px; margin-bottom: 20px; }
        .features-list { list-style: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
        .features-list li { background: #fff; padding: 15px 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .room-type-info { padding: 20px; border-radius: 16px; background: #f8f9ff; border: 1px solid #e2e8f0; }
        .room-type-info p { font-size: 1rem; color: #4a5568; display: flex; gap: 10px; }
        .booking-box { flex: 1; min-width: 320px; background: #fff; height: fit-content; position: sticky; padding: 25px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); top: 100px; }
        .price-value { font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .detail-booking-form { display: flex; flex-direction: column; gap: 16px; }
        .detail-booking-form label { display: flex; flex-direction: column; gap: 8px; }
        .detail-booking-form input { width: 100%; padding: 16px 18px; border: 2px solid #e2e8f0; border-radius: 16px; font-size: 15px; height: 56px; }
        .btn-book-styled { width: 100%; height: 56px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .reviews-section { margin-top: 40px; padding: 30px; background: #fff; border-radius: 20px; }
        .review-item { background: #f8f9ff; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .review-header strong { color: #2d3748; }
        .review-header .stars { color: #ffc107; }
        .review-item p { color: #4a5568; margin: 10px 0; }
        .review-item small { color: #a0aec0; display: block; margin-top: 5px; }
        #rating-select, #comment { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .submit-btn { padding: 12px 25px; background: #667eea; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 10px; }
        @media (max-width: 992px) { .resort-details-wrapper { flex-direction: column; } .booking-box { position: static; } }
        .navbar { background: rgba(255,255,255,0.95); position: fixed; width: 100%; top: 0; z-index: 1000; padding: 16px 40px; box-shadow: 0 8px 32px rgba(0,0,0,0.08); }
        .navbar-menu { display: flex; gap: 30px; }
        .navbar-menu a { color: #2d3748; text-decoration: none; font-weight: 600; }
        footer { background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%); color: #fff; text-align: center; padding: 40px; margin-top: 80px; }
    </style>
</head>
<body>
    <header class="navbar">
        <div style="max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
            <a href="home.html" style="text-decoration: none; color: #667eea; font-size: 24px; font-weight: 800;">Resort Booking</a>
            <nav class="navbar-menu">
                <a href="">Khuyến mãi</a>
                <a href="">Hỗ trợ</a>
                <a href="my_bookings.html">Đặt chỗ của tôi</a>
            </nav>
        </div>
    </header>

    <main class="detail-container">
        <div id="loading" style="text-align: center; padding: 50px;"><i class="fas fa-spinner fa-spin fa-2x"></i> Đang tải...</div>
        <div id="error-message" style="color: red; text-align: center; padding: 50px; display: none;"></div>

        <div id="resort-content" style="display: none;">
            <section class="resort-header">
                <h1 id="resort-name"></h1>
                <p class="resort-location"><i class="fas fa-map-marker-alt"></i> <span id="resort-location-text"></span></p>
                <p class="resort-location" style="font-size: 0.95rem;"><i class="fas fa-building"></i> <span id="resort-specific-address"></span></p>
            </section>
            
            <section class="image-gallery">
                <div id="main-image-container" class="main-image"></div>
                <div id="thumbnail-gallery" class="thumbnail-gallery"></div>
            </section>
            
            <section class="resort-details-wrapper">
                <div class="details-main">
                    <h2>Mô tả Resort</h2>
                    <p id="resort-description"></p>
                    
                    <h2 style="margin-top: 30px;">Tiện ích</h2>
                    <ul id="resort-features" class="features-list"></ul>
                    
                    <div class="room-type-info">
                        <h3>Thông tin phòng</h3>
                        <p><i class="fas fa-bed"></i> Số giường: <span id="room-bed-config-display"></span></p>
                        <p><i class="fas fa-users"></i> Sức chứa: <span id="room-capacity"></span> người</p>
                    </div>
                </div>
                
                <aside class="booking-box">
                    <p>Giá chỉ từ <span id="resort-price" class="price-value"></span> / đêm</p>
                    
                    <div class="detail-booking-form">
                        <label><span>Ngày nhận phòng</span><input type="text" id="check-in" placeholder="Chọn ngày" readonly></label>
                        <label><span>Ngày trả phòng</span><input type="text" id="check-out" placeholder="Chọn ngày" readonly></label>
                        <button id="book-now-btn" class="btn-book-styled">Đặt Phòng Ngay</button>
                    </div>
                </aside>
            </section>

            <section class="reviews-section">
                <h3>Đánh giá & Bình luận (<span id="rating-count">0</span>)</h3>
                <div id="review-list"></div>
                
                <form id="review-form" class="review-form" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                    <label for="rating-select">Đánh giá của bạn:</label>
                    <select id="rating-select" required style="width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <option value="" disabled selected>Chọn số sao</option>
                        <option value="1">⭐️</option>
                        <option value="2">⭐️⭐️</option>
                        <option value="3">⭐️⭐️⭐️</option>
                        <option value="4">⭐️⭐️⭐️⭐️</option>
                        <option value="5">⭐️⭐️⭐️⭐️⭐️</option>
                    </select>
                    <textarea id="comment" rows="3" placeholder="Viết bình luận của bạn..." required></textarea>
                    <button type="submit" class="submit-btn">Gửi đánh giá</button>
                </form>
            </section>
        </div>
    </main>

    <footer>
        <p>© 2025 Resort Booking. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE = "http://localhost:5500";
            let currentRoom = null;

            function getQueryParam(param) { return new URLSearchParams(window.location.search).get(param); }
            function formatCurrency(amount) { const n = parseFloat(amount); return (isNaN(n) || n <= 0) ? "Liên hệ" : new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n); }
            function resolveImageUrl(url) { if (!url) return 'https://via.placeholder.com/800x600?text=No+Image'; if (/^https?:\/\//i.test(url)) return url; if (url.startsWith('/')) return API_BASE + url; return API_BASE + '/uploads/' + url; }
            function getLocationName(key) { const m = { 'da-lat': 'Đà Lạt', 'ha-long': 'Hạ Long', 'phu-quoc': 'Phú Quốc', 'nha-trang': 'Nha Trang', 'da-nang': 'Đà Nẵng', 'sapa': 'Sapa', 'hoi-an': 'Hội An', 'ha-noi': 'Hà Nội', 'sai-gon': 'Sài Gòn' }; return m[key] || key || 'Không xác định'; }

            async function loadReviews(roomId) {
                const container = document.getElementById('review-list');
                const ratingCount = document.getElementById('rating-count');
                container.innerHTML = "<p>Đang tải đánh giá...</p>";
                try {
                    const res = await fetch(`${API_BASE}/api/reviews/${roomId}`);
                    if (!res.ok) throw new Error('Lỗi');
                    const reviews = await res.json();
                    if(ratingCount) ratingCount.textContent = reviews.length;
                    container.innerHTML = reviews.length ? reviews.map(r => `<div class="review-item"><div class="review-header"><strong>${r.username || 'Người dùng'}</strong><span class="stars">${'★'.repeat(r.rating)}${'☆'.repeat(5 - r.rating)}</span></div><p>${r.comment}</p><small>${new Date(r.created_at).toLocaleString('vi-VN')}</small></div>`).join('') : "<p>Chưa có đánh giá nào.</p>";
                } catch (err) { container.innerHTML = "<p>Lỗi tải đánh giá.</p>"; }
            }

            function displayRoom() {
                const loading = document.getElementById('loading');
                const content = document.getElementById('resort-content');
                
                document.title = currentRoom.resort_name || "Chi tiết Resort";
                document.getElementById('resort-name').textContent = currentRoom.resort_name || "Tên không xác định";
                document.getElementById('resort-location-text').textContent = getLocationName(currentRoom.location);
                document.getElementById('resort-specific-address').textContent = currentRoom.address || '(Chưa có)';
                document.getElementById('resort-description').textContent = currentRoom.description || 'Chưa có mô tả.';
                document.getElementById('resort-price').textContent = formatCurrency(currentRoom.price_per_night || 0);
                document.getElementById('room-bed-config-display').textContent = currentRoom.num_bed || "Đang cập nhật";
                document.getElementById('room-capacity').textContent = currentRoom.capacity || "?";

                const featuresList = document.getElementById('resort-features');
                if (currentRoom.features && Array.isArray(currentRoom.features) && currentRoom.features.length > 0) {
                    featuresList.innerHTML = currentRoom.features.map(f => `<li>✓ ${f}</li>`).join('');
                } else {
                    featuresList.innerHTML = '<li>Chưa có thông tin.</li>';
                }

                const mainImageContainer = document.getElementById('main-image-container');
                const thumbnailGallery = document.getElementById('thumbnail-gallery');
                mainImageContainer.innerHTML = '';
                thumbnailGallery.innerHTML = '';
                
                let images = currentRoom.images || [];
                if (typeof images === 'string') {
                    images = images.trim() ? images.split(',').map(img => img.trim()) : [];
                } else if (!Array.isArray(images)) {
                    images = [];
                }
                
                if (images.length > 0) {
                    const mainImg = document.createElement('img');
                    mainImg.src = resolveImageUrl(images[0]);
                    mainImg.onerror = () => mainImg.src = 'https://via.placeholder.com/800x600?text=No+Image';
                    mainImageContainer.appendChild(mainImg);
                    
                    images.forEach((imgUrl, idx) => {
                        const thumbImg = document.createElement('img');
                        thumbImg.src = resolveImageUrl(imgUrl);
                        thumbImg.className = idx === 0 ? 'active' : '';
                        thumbImg.onclick = () => {
                            mainImg.src = resolveImageUrl(imgUrl);
                            document.querySelectorAll('.thumbnail-gallery img').forEach(i => i.classList.remove('active'));
                            thumbImg.classList.add('active');
                        };
                        thumbnailGallery.appendChild(thumbImg);
                    });
                } else {
                    mainImageContainer.innerHTML = `<img src="https://via.placeholder.com/800x600?text=No+Image" alt="Placeholder">`;
                }

                let checkoutPicker = flatpickr("#check-out", { dateFormat: "d/m/Y", locale: "vn", minDate: new Date().fp_incr(1) });
                flatpickr("#check-in", { dateFormat: "d/m/Y", locale: "vn", minDate: "today", onChange: function(d) { if (d[0]) checkoutPicker.set('minDate', new Date(d[0]).fp_incr(1)); } });
                
                loadReviews(currentRoom.id);
                
                loading.style.display = 'none';
                content.style.display = 'block';
            }

            async function fetchResortDetail() {
                const resortId = getQueryParam('id');
                const dataParam = getQueryParam('data');
                const loading = document.getElementById('loading');
                const error = document.getElementById('error-message');
                
                if (!resortId) { 
                    loading.style.display = 'none'; 
                    error.textContent = 'Lỗi: Không tìm thấy ID resort.'; 
                    error.style.display = 'block'; 
                    return; 
                }

                try {
                    if (dataParam) {
                        currentRoom = JSON.parse(decodeURIComponent(dataParam));
                    } else {
                        const res = await fetch(`${API_BASE}/api/rooms/${resortId}`);
                        if (!res.ok) throw new Error('Lỗi tải dữ liệu');
                        currentRoom = await res.json();
                    }
                    
                    displayRoom();
                } catch (err) {
                    console.error(err);
                    loading.style.display = 'none';
                    error.textContent = `Lỗi: ${err.message}`;
                    error.style.display = 'block';
                }
            }

            fetchResortDetail();
            
            document.getElementById('book-now-btn').addEventListener('click', () => {
                if (!localStorage.getItem('token')) { alert('Bạn cần đăng nhập!'); return; }
                const checkIn = document.getElementById('check-in').value;
                const checkOut = document.getElementById('check-out').value;
                if (!checkIn || !checkOut) { alert('Vui lòng chọn ngày!'); return; }
                sessionStorage.setItem('bookingDetails', JSON.stringify({
                    resortId: currentRoom.id, resortName: currentRoom.resort_name, capacity: currentRoom.capacity,
                    pricePerNight: currentRoom.price_per_night, checkIn, checkOut, num_bed: currentRoom.num_bed
                }));
                window.location.href = 'payment.html';
            });

            document.getElementById('review-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const comment = document.getElementById('comment').value.trim();
                const ratingSelect = document.getElementById('rating-select');
                const selectedRating = parseInt(ratingSelect.value);
                if (isNaN(selectedRating)) { alert('Vui lòng chọn số sao.'); return; }
                const submitButton = e.target.querySelector('.submit-btn');
                submitButton.textContent = 'Đang gửi...';
                submitButton.disabled = true;
                try {
                    const res = await fetch(`${API_BASE}/api/reviews`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rating: selectedRating, comment, room_id: currentRoom.id, username: localStorage.getItem('username') || "Khách ẩn danh" })
                    });
                    if (!res.ok) throw new Error('Lỗi');
                    document.getElementById('comment').value = '';
                    ratingSelect.value = "";
                    await loadReviews(currentRoom.id);
                } catch (err) { alert('Lỗi gửi đánh giá.'); } 
                finally {
                    submitButton.textContent = 'Gửi đánh giá';
                    submitButton.disabled = false;
                }
            });
        });
    </script>
</body>
</html>